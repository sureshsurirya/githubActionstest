name: sub_account_setup

env:
  SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
  SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
  SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
  SNOWSQL_ROLE: ${{ secrets.SNOWSQL_ROLE }}
  SNOWSQL_WAREHOUSE: ${{ secrets.SNOWSQL_WAREHOUSE }}
  SNOWSQL_DATABASE: ${{ secrets.TGT_DB }}
  SNOWSQL_SCHEMA: ${{ secrets.TGT_SCHEMA }}
  SNOWSQL_RAW_DB: ${{ secrets.SRC_DB }}
  SNOWSQL_SRC_SCHEMA: ${{ secrets.SRC_SCHEMA }}
  SNOWSQL_CUSTOMER: ${{ secrets.CUST_NAME }}
  SNOWSQL_ADMIN_PSW: ${{ secrets.ADMIN_PASSWORD }}

on:
  workflow_dispatch:

jobs:
  executequery:
    name: Sub account setup Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.9-linux_x86_64.bash

      - name: Install SnowSQL
        run: |
          SNOWSQL_DEST=~/snowflake SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.9-linux_x86_64.bash

      - name: Test installation
        run: ~/snowflake/snowsql -v

      - name: Variable Substitution
        run: echo "variable_substitution=true" | tee -a ~/.snowsql/config

      - name: Create Snowflake Account
        run: |
          json_response=$(
            ~/snowflake/snowsql <<EOF
            CREATE ACCOUNT myaccount11
            ADMIN_NAME = admin
            ADMIN_PASSWORD = '${{ secrets.ADMIN_PASSWORD }}'
            EMAIL = 'myemail@myorg.org'
            MUST_CHANGE_PASSWORD = FALSE
            EDITION = enterprise;
            EOF
          )
          
          echo "$json_response" # Print the JSON response for debugging

      - name: Save JSON Response to File
        run: echo "$json_response" > json_response.json

      - name: Display JSON Response from File
        run: cat json_response.json

      - name: Extract Values from JSON Response
        run: |
          # Extract specific values from the JSON response file using jq and handle missing or non-numeric values
          accountLocator=$(jq -r '.accountLocator' json_response.json || echo "N/A")
          accountLocatorUrl=$(jq -r '.accountLocatorUrl' json_response.json || echo "N/A")
          accountName=$(jq -r '.accountName' json_response.json || echo "N/A")
          url=$(jq -r '.url' json_response.json || echo "N/A")
          edition=$(jq -r '.edition' json_response.json || echo "N/A")

          # Display extracted values
          echo "accountLocator: $accountLocator"
          echo "accountLocatorUrl: $accountLocatorUrl"
          echo "accountName: $accountName"
          echo "url: $url"
          echo "edition: $edition"
