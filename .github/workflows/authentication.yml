name: Authentication

env:
  SNOWSQL_ACCOUNT: ${{ vars.SNOWSQL_ACCOUNT }}
  SNOWSQL_USER: ${{ vars.SNOWSQL_USER }}
  SNOWSQL_PWD: ${{ vars.SNOWSQL_PWD }}
  SNOWSQL_ROLE: ${{ vars.SNOWSQL_ROLE }}
  SNOWSQL_WAREHOUSE: ${{ vars.SNOWSQL_WAREHOUSE }}
  SNOWSQL_DATABASE: ${{ vars.TGT_DB }}
  SNOWSQL_SCHEMA: ${{ vars.TGT_SCHEMA }}
  SNOWSQL_RAW_DB: ${{ vars.SRC_DB }}
  SNOWSQL_SRC_SCHEMA: ${{ vars.SRC_SCHEMA }}
  SNOWSQL_CUST_NAME: ${{ vars.CUST_NAME }}
  SNOWSQL_ADMIN_PASSWORD: ${{ vars.ADMIN_PASSWORD }}
  SNOWSQL_CUST_EMAIL: ${{ vars.CUST_EMAIL }}
  SNOWSQL_CUST_DB: ${{ vars.CUST_DB }}
  SNOWSQL_CUST_SCHEMA: ${{ vars.CUST_SCHEMA }}

on:
  workflow_dispatch:

jobs:
  executequery:
    name: Sub account setup Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Download SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.9-linux_x86_64.bash

      - name: Install SnowSQL
        run: |
          SNOWSQL_DEST=~/snowflake SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.9-linux_x86_64.bash

      - name: Test installation
        run: ~/snowflake/snowsql -v

      - name: Variable Substitution
        run: echo "variable_substitution=true" | tee -a ~/.snowsql/config

      - name: Setup SnowSQL and Create Snowflake Account
        run: |
          ~/snowflake/snowsql <<EOF
          USE ROLE ACCOUNTADMIN;
          CREATE OR REPLACE SHARE ${{ env.SNOWSQL_CUST_NAME }}_SHARE;
          USE DATABASE ${{ env.SNOWSQL_CUST_DB }};
          GRANT USAGE ON DATABASE ${{ env.SNOWSQL_CUST_DB }} TO SHARE "${{ env.SNOWSQL_CUST_NAME }}_SHARE";
          GRANT USAGE ON SCHEMA ${{ env.SNOWSQL_CUST_SCHEMA }} TO SHARE "${{ env.SNOWSQL_CUST_NAME }}_SHARE";
          GRANT SELECT ON ALL TABLES IN SCHEMA ${{ env.SNOWSQL_CUST_DB }}.${{ env.SNOWSQL_CUST_SCHEMA }} TO SHARE "${{ env.SNOWSQL_CUST_NAME }}_SHARE";
          EOF

          ~/snowflake/snowsql <<EOF > account_details.txt
          CREATE ACCOUNT ${{ env.SNOWSQL_CUST_NAME }}
          ADMIN_NAME = admin
          ADMIN_PASSWORD = "${{ env.SNOWSQL_ADMIN_PASSWORD }}"
          EMAIL = '${{ env.SNOWSQL_CUST_EMAIL }}'
          MUST_CHANGE_PASSWORD = FALSE
          EDITION = enterprise;
          EOF
          cat account_details.txt | wc -l
          head -n 6 account_details.txt | tail -n 1 > url.json
          cat url.json
          # Remove leading and trailing "|" from the file
          sed -i 's/^ *| *//; s/ *| *$//' url.json
          Locator=`jq -r '.accountLocator' url.json`
          echo ""
          echo "Locator: $Locator"
          accountLocatorUrl=`jq -r '.accountLocatorUrl' url.json`
          echo ""
          echo "accountLocatorUrl: $accountLocatorUrl"
          ~/snowflake/snowsql -r ACCOUNTADMIN -q "ALTER SHARE \"${{ env.SNOWSQL_CUST_NAME }}_SHARE\" ADD ACCOUNTS = $Locator;"

      - name: Access New Sub-Account
        run: |
           # Extract the admin password from the environment variable
            admin_password="${{ env.SNOWSQL_ADMIN_PASSWORD }}"
    
            # Extract the accountLocatorUrl from the environment variable
            accountLocatorUrl="${{ env.accountLocatorUrl }}"
    
            # Perform the authentication and access the sub-account
            response=$(curl -X POST -c cookies.txt "${accountLocatorUrl}/login" -d "username=admin&password=${admin_password}")

            # Check if the response indicates successful login
            if [[ $response == *"Successfully logged in"* ]]; then
            echo "Successfully logged in to the sub-account."
      
                # Now you can make further requests to the sub-account as needed.
              # For example, you can use `curl` to perform additional actions.
              # Example:
              # curl -b cookies.txt "${accountLocatorUrl}/some_endpoint"
      
              else
                echo "Login to the sub-account failed."
                exit 1
                 fi

